<!DOCTYPE html>
<html>
<head>
    <title>Debug iOS - Usuarios</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        h1 {
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #888;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .stat-card h3 {
            color: #d4af37;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }
        
        .stat-number.good {
            color: #4CAF50;
        }
        
        .stat-number.bad {
            color: #f44336;
        }
        
        .tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .table-container {
            background: #1a1a1a;
            border-radius: 10px;
            border: 1px solid #333;
            overflow: hidden;
        }
        
        .table-header {
            background: #222;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
        }
        
        .table-header h3 {
            color: #d4af37;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .table-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #252525;
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
            color: #d4af37;
            border-bottom: 1px solid #333;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            color: #ccc;
        }
        
        tr:hover {
            background: #222;
        }
        
        .missing-users {
            background: #2d1a1a;
            border: 1px solid #5c1a1a;
        }
        
        .missing-users .table-header {
            background: #3d1a1a;
        }
        
        .missing-users th {
            color: #ff6b6b;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-ok {
            background: #1a3a2d;
            color: #90ee90;
        }
        
        .status-missing {
            background: #3a1a1a;
            color: #ff6b6b;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #e4bf47;
        }
        
        .refresh-btn {
            background: #1a5c3a;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #2d8659;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #d4af37;
        }
        
        .error {
            background: #5c1a1a;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #8c2d2d;
        }
        
        .timestamp {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #333;
        }
        
        .user-id {
            font-size: 10px;
            color: #666;
            font-family: monospace;
            word-break: break-all;
        }
        
        .email-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .tables {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Debug iOS - Sistema de Usuarios</h1>
            <p class="subtitle">Verificaci√≥n de sincronizaci√≥n entre Authentication y Tabla Clientes</p>
        </header>
        
        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <h3>üë• Usuarios en Auth</h3>
                <div class="stat-number" id="authCount">0</div>
                <p>Total de usuarios registrados en Authentication</p>
            </div>
            
            <div class="stat-card">
                <h3>üìã Usuarios en Clientes</h3>
                <div class="stat-number" id="clientesCount">0</div>
                <p>Total de usuarios en tabla clientes</p>
            </div>
            
            <div class="stat-card">
                <h3>‚ùå Usuarios Faltantes</h3>
                <div class="stat-number bad" id="missingCount">0</div>
                <p>Usuarios en Auth pero NO en Clientes</p>
            </div>
            
            <div class="stat-card">
                <h3>‚úÖ Sincronizaci√≥n</h3>
                <div class="stat-number good" id="syncPercentage">0%</div>
                <p>Porcentaje de usuarios sincronizados</p>
            </div>
        </div>
        
        <div class="tables">
            <div class="table-container">
                <div class="table-header">
                    <h3>üë§ Usuarios en Authentication</h3>
                </div>
                <div class="table-body">
                    <table id="authTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>ID</th>
                                <th>Creado</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="authTableBody">
                            <!-- Los datos se llenar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>üìã Usuarios en Tabla Clientes</h3>
                </div>
                <div class="table-body">
                    <table id="clientesTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Nombre</th>
                                <th>Creado</th>
                                <th>Rol</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTableBody">
                            <!-- Los datos se llenar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="table-container missing-users">
            <div class="table-header">
                <h3>‚ö†Ô∏è Usuarios Faltantes en Tabla Clientes</h3>
            </div>
            <div class="table-body">
                <table id="missingTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>ID</th>
                            <th>Creado en Auth</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="missingTableBody">
                        <!-- Los datos se llenar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="errorContainer" style="display: none;"></div>
        
        <div class="actions">
            <button onclick="checkAllUsers()" class="refresh-btn">
                üîÑ Actualizar Datos
            </button>
            <button onclick="exportToCSV()">
                üì• Exportar a CSV
            </button>
            <button onclick="clearData()">
                üóëÔ∏è Limpiar Vista
            </button>
        </div>
        
        <div class="loading" id="loading">
            <p>üîÑ Cargando datos...</p>
            <p style="font-size: 14px; color: #888; margin-top: 10px;">
                Conectando a Supabase...
            </p>
        </div>
        
        <div class="timestamp" id="timestamp">
            √öltima actualizaci√≥n: --
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://nllllvztipbrhryzxamm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sbGxsdnp0aXBicmhyeXp4YW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTkxMjMsImV4cCI6MjA3ODczNTEyM30.mg8mx2ACsG1VDqjt8jw_DyzU6v1aT8rRdpS0ByBGRq4';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        let allData = {
            authUsers: [],
            clientes: [],
            missingUsers: []
        };
        
        async function checkAllUsers() {
            const loadingEl = document.getElementById('loading');
            const errorContainer = document.getElementById('errorContainer');
            
            loadingEl.style.display = 'block';
            errorContainer.style.display = 'none';
            
            try {
                console.log('üîç Verificando todos los usuarios...');
                
                // 1. Verificar usuarios en auth (esto requiere admin privileges)
                let authUsers = [];
                try {
                    // Intenta con admin API primero
                    const { data: { users }, error: authError } = await supabaseClient.auth.admin.listUsers();
                    if (authError) throw authError;
                    authUsers = users || [];
                    console.log('‚úÖ Auth users loaded:', authUsers.length);
                } catch (authError) {
                    console.warn('‚ö†Ô∏è No se pudo acceder a admin API, intentando m√©todo alternativo...');
                    
                    // M√©todo alternativo: obtener sesi√≥n actual y datos de usuarios
                    // Esto solo mostrar√° el usuario actual
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session?.user) {
                        authUsers = [session.user];
                    }
                }
                
                // 2. Verificar usuarios en tabla clientes
                const { data: clientes, error: clientesError } = await supabaseClient
                    .from('clientes')
                    .select('id, email, nombre, apellido, rol, creado_en, proveedor');
                
                if (clientesError) {
                    throw new Error('Error en tabla clientes: ' + clientesError.message);
                }
                
                // 3. Encontrar usuarios en auth pero NO en clientes
                const authEmails = authUsers.map(u => u.email?.toLowerCase()).filter(Boolean);
                const clienteEmails = clientes.map(c => c.email?.toLowerCase()).filter(Boolean);
                
                const missingUsers = authUsers.filter(user => {
                    const email = user.email?.toLowerCase();
                    return email && !clienteEmails.includes(email);
                });
                
                // Guardar datos
                allData = {
                    authUsers,
                    clientes: clientes || [],
                    missingUsers
                };
                
                // Actualizar UI
                updateStats();
                updateAuthTable();
                updateClientesTable();
                updateMissingTable();
                
                // Actualizar timestamp
                document.getElementById('timestamp').textContent = 
                    `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showError(error.message);
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        function updateStats() {
            const { authUsers, clientes, missingUsers } = allData;
            
            document.getElementById('authCount').textContent = authUsers.length;
            document.getElementById('clientesCount').textContent = clientes.length;
            document.getElementById('missingCount').textContent = missingUsers.length;
            
            // Calcular porcentaje de sincronizaci√≥n
            const syncPercentage = authUsers.length > 0 
                ? Math.round(((authUsers.length - missingUsers.length) / authUsers.length) * 100)
                : 0;
            
            document.getElementById('syncPercentage').textContent = `${syncPercentage}%`;
        }
        
        function updateAuthTable() {
            const tbody = document.getElementById('authTableBody');
            const { authUsers } = allData;
            
            // Calcular emails de clientes para verificaci√≥n
            const clienteEmails = allData.clientes.map(c => c.email?.toLowerCase());
            
            tbody.innerHTML = '';
            
            authUsers.forEach(user => {
                const row = document.createElement('tr');
                const isInClientes = clienteEmails.includes(user.email?.toLowerCase());
                
                row.innerHTML = `
                    <td class="email-cell" title="${user.email}">${user.email || 'No email'}</td>
                    <td><span class="user-id" title="${user.id}">${user.id.substring(0, 8)}...</span></td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <span class="status ${isInClientes ? 'status-ok' : 'status-missing'}">
                            ${isInClientes ? '‚úÖ En tabla' : '‚ùå Faltante'}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateClientesTable() {
            const tbody = document.getElementById('clientesTableBody');
            const { clientes } = allData;
            
            tbody.innerHTML = '';
            
            clientes.forEach(cliente => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="email-cell" title="${cliente.email}">${cliente.email || 'No email'}</td>
                    <td>${cliente.nombre || ''} ${cliente.apellido || ''}</td>
                    <td>${cliente.creado_en ? new Date(cliente.creado_en).toLocaleDateString() : 'N/A'}</td>
                    <td>${cliente.rol || 'cliente'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateMissingTable() {
            const tbody = document.getElementById('missingTableBody');
            const { missingUsers } = allData;
            
            tbody.innerHTML = '';
            
            missingUsers.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="email-cell" title="${user.email}">${user.email || 'No email'}</td>
                    <td><span class="user-id" title="${user.id}">${user.id.substring(0, 8)}...</span></td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <button onclick="fixMissingUser('${user.email}', '${user.id}')" 
                                style="padding: 5px 10px; font-size: 12px;">
                            üîß Arreglar
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        async function fixMissingUser(email, userId) {
            if (!confirm(`¬øCrear usuario ${email} en tabla clientes?`)) return;
            
            try {
                // Extraer nombre del email
                const nombrePart = email.split('@')[0];
                const nombre = nombrePart.split('.')[0] || nombrePart;
                const apellido = nombrePart.split('.')[1] || 'Usuario';
                
                const { error } = await supabaseClient
                    .from('clientes')
                    .insert([{
                        id: userId,
                        nombre: nombre.charAt(0).toUpperCase() + nombre.slice(1),
                        apellido: apellido.charAt(0).toUpperCase() + apellido.slice(1),
                        email: email,
                        rol: 'cliente',
                        proveedor: 'google',
                        creado_en: new Date().toISOString(),
                        email_confirmado: true,
                        ultimo_login: new Date().toISOString()
                    }]);
                
                if (error) {
                    throw error;
                }
                
                alert(`‚úÖ Usuario ${email} creado en tabla clientes`);
                checkAllUsers(); // Refrescar datos
                
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Posibles causas:
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Problemas de conexi√≥n con Supabase</li>
                            <li>Permisos insuficientes para leer tablas</li>
                            <li>Token de autenticaci√≥n expirado</li>
                        </ul>
                    </p>
                </div>
            `;
            errorContainer.style.display = 'block';
        }
        
        function exportToCSV() {
            const { authUsers, clientes, missingUsers } = allData;
            
            // Crear CSV para auth users
            let csv = 'Usuarios en Authentication\n';
            csv += 'Email,ID,Creado\n';
            authUsers.forEach(user => {
                csv += `"${user.email}","${user.id}","${user.created_at}"\n`;
            });
            
            csv += '\n\nUsuarios en Tabla Clientes\n';
            csv += 'Email,Nombre,Apellido,Rol,Creado\n';
            clientes.forEach(cliente => {
                csv += `"${cliente.email}","${cliente.nombre}","${cliente.apellido}","${cliente.rol}","${cliente.creado_en}"\n`;
            });
            
            csv += '\n\nUsuarios Faltantes\n';
            csv += 'Email,ID,Creado\n';
            missingUsers.forEach(user => {
                csv += `"${user.email}","${user.id}","${user.created_at}"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `usuarios_debug_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function clearData() {
            if (confirm('¬øLimpiar todos los datos de la vista?')) {
                document.getElementById('authTableBody').innerHTML = '';
                document.getElementById('clientesTableBody').innerHTML = '';
                document.getElementById('missingTableBody').innerHTML = '';
                
                document.getElementById('authCount').textContent = '0';
                document.getElementById('clientesCount').textContent = '0';
                document.getElementById('missingCount').textContent = '0';
                document.getElementById('syncPercentage').textContent = '0%';
                
                document.getElementById('timestamp').textContent = '√öltima actualizaci√≥n: --';
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', checkAllUsers);
        
        // Auto-refresh cada 30 segundos
        setInterval(checkAllUsers, 30000);
    </script>
</body>
</html>