name: üìß Recordatorios Autom√°ticos

on:
  schedule:
    # Ejecutar cada 5 minutos
    - cron: '*/5 * * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub
  workflow_dispatch:

env:
  SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
  TZ: 'America/Merida'  # Yucat√°n usa America/Merida

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    env:
      TZ: 'America/Merida'  # Zona horaria de Yucat√°n
    
    steps:
    - name: üîç Verificar configuraci√≥n y hora
      run: |
        echo "üïê ===== INICIO DE EJECUCI√ìN ====="
        echo "üìç UBICACI√ìN: Yucat√°n, M√©xico"
        echo "‚è∞ Zona horaria: $TZ"
        echo "üìÖ Fecha UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "üìÖ Fecha Yucat√°n: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "üîó Supabase URL: ${{ env.SUPABASE_URL }}"
        
        # Calcular ventana de recordatorios
        HORA_ACTUAL=$(date '+%H:%M')
        HORA_55_MIN=$(date -d '55 minutes' '+%H:%M')
        HORA_65_MIN=$(date -d '65 minutes' '+%H:%M')
        
        echo "‚è∞ Hora actual (Yucat√°n): $HORA_ACTUAL"
        echo "üéØ Ventana de recordatorios (55-65 min antes):"
        echo "   - Hora +55 min: $HORA_55_MIN"
        echo "   - Hora +65 min: $HORA_65_MIN"
        echo ""
        echo "üìù EJEMPLO: Si una cita es a las 15:00"
        echo "   Se enviar√° recordatorio entre 14:55 y 14:05"
    
    - name: üìû Llamar a funci√≥n de recordatorios
      id: ejecutar-recordatorios
      env:
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "üìß Ejecutando funci√≥n de recordatorios..."
        
        # Verificar que la key est√° configurada
        if [ -z "$SUPABASE_KEY" ]; then
          echo "‚ùå ERROR: SUPABASE_SERVICE_ROLE_KEY no est√° configurada"
          echo "üîç Verifica que el secret existe en Settings > Secrets"
          exit 1
        fi
        
        echo "‚úÖ Service Role Key configurada correctamente"
        
        # URL completa de la funci√≥n
        FUNCTION_URL="${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos"
        echo "üåê URL de funci√≥n: $FUNCTION_URL"
        
        # Crear timestamp en hora de Yucat√°n
        TIMESTAMP_YUCATAN=$(date '+%Y-%m-%dT%H:%M:%S')
        HORA_ACTUAL=$(date '+%H:%M:%S')
        FECHA_HOY=$(date '+%Y-%m-%d')
        
        echo "üïê Timestamp Yucat√°n: $TIMESTAMP_YUCATAN"
        echo "‚è∞ Hora actual: $HORA_ACTUAL"
        echo "üìÖ Fecha hoy: $FECHA_HOY"
        
        # Hacer la petici√≥n
        echo "üîÑ Llamando a Edge Function..."
        response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
          -X POST "$FUNCTION_URL" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Recordatorios/1.0" \
          --max-time 120 \
          --retry 2 \
          --retry-delay 5 \
          -d "{
            \"source\": \"github-actions\",
            \"timestamp_yucatan\": \"$TIMESTAMP_YUCATAN\",
            \"hora_actual\": \"$HORA_ACTUAL\",
            \"fecha_hoy\": \"$FECHA_HOY\",
            \"ejecucion_automatica\": true
          }" 2>&1)
        
        # Extraer c√≥digo HTTP
        http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2 || echo "0")
        body=$(echo "$response" | sed '/HTTP_CODE:/d' || echo "No response body")
        
        echo "üìä C√≥digo HTTP: $http_code"
        echo "üì¶ Respuesta completa:"
        
        # Intentar formatear JSON si es posible
        if command -v jq &> /dev/null; then
          echo "$body" | jq . 2>/dev/null || echo "$body"
        else
          echo "$body"
        fi
        
        # Guardar salidas
        echo "http_code=$http_code" >> $GITHUB_OUTPUT
        
        # Para body multil√≠nea usar delimiter
        cat << 'EOF' >> $GITHUB_OUTPUT
response_body<<RESPONSE_EOF
$(echo "$body")
RESPONSE_EOF
EOF
        
        # Extraer datos de la respuesta
        if [ ! -z "$body" ]; then
          total_citas=$(echo "$body" | grep -o '"total_citas":[0-9]*' | head -1 | cut -d: -f2 || echo "0")
          enviados=$(echo "$body" | grep -o '"recordatorios_enviados":[0-9]*' | head -1 | cut -d: -f2 || echo "0")
          errores=$(echo "$body" | grep -o '"errores":[0-9]*' | head -1 | cut -d: -f2 || echo "0")
          
          echo "üìä Datos extra√≠dos:"
          echo "   Total citas: $total_citas"
          echo "   Enviados: $enviados"
          echo "   Errores: $errores"
          
          echo "total_citas=$total_citas" >> $GITHUB_OUTPUT
          echo "enviados=$enviados" >> $GITHUB_OUTPUT
          echo "errores=$errores" >> $GITHUB_OUTPUT
        fi
        
        # Verificar √©xito
        if [ "$http_code" = "200" ]; then
          echo "‚úÖ √âxito - Recordatorios procesados"
          exit 0
        else
          echo "‚ùå Error HTTP: $http_code"
          exit 1
        fi
    
    - name: üìä Generar reporte detallado
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "     üìã REPORTE DETALLADO - YUCAT√ÅN"
        echo "=========================================="
        echo "üìç UBICACI√ìN: Yucat√°n, M√©xico"
        echo "‚è∞ Zona horaria: America/Merida (UTC-6)"
        echo "üìÖ Fecha (Yucat√°n): $(date '+%Y-%m-%d %H:%M:%S')"
        echo "üìÖ D√≠a: $(date '+%A, %d de %B de %Y')"
        echo "üîß Workflow: ${{ github.workflow }}"
        echo "üéØ Trigger: ${{ github.event_name }}"
        echo "üîÑ Run ID: ${{ github.run_id }}"
        echo "üì§ Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code || 'N/A' }}"
        echo "üìä Citas evaluadas: ${{ steps.ejecutar-recordatorios.outputs.total_citas || '0' }}"
        echo "‚úÖ Emails enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados || '0' }}"
        echo "‚ùå Errores: ${{ steps.ejecutar-recordatorios.outputs.errores || '0' }}"
        echo ""
        
        # Mostrar informaci√≥n de tiempo
        HORA_ACTUAL=$(date '+%H:%M:%S')
        echo "‚è∞ HORA ACTUAL: $HORA_ACTUAL"
        echo ""
        echo "üéØ VENTANA DE RECORDATORIOS:"
        echo "   - Se env√≠an entre 55-65 minutos antes de la cita"
        echo "   - Ejemplo: Cita a las 15:00 ‚Üí Recordatorio 14:55 a 14:05"
        echo ""
        echo "‚è∞ PR√ìXIMA EJECUCI√ìN: $(date -d '+5 minutes' '+%H:%M:%S')"
        echo "=========================================="
        
        # Crear archivo de log - VERSI√ìN CORREGIDA
        LOG_FILE="recordatorios-$(date '+%Y%m%d-%H%M%S').log"
        
        cat > "$LOG_FILE" << 'LOGFILE_EOF'
# Reporte de Recordatorios Autom√°ticos - Yucat√°n
# =============================================
Fecha ejecuci√≥n (Yucat√°n): $(date '+%Y-%m-%d %H:%M:%S')
Zona horaria: America/Merida (UTC-6)
Workflow: ${{ github.workflow }}
Run ID: ${{ github.run_id }}
Trigger: ${{ github.event_name }}
Hora actual: $(date '+%H:%M:%S')
Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code || 'N/A' }}
Citas evaluadas: ${{ steps.ejecutar-recordatorios.outputs.total_citas || '0' }}
Recordatorios enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados || '0' }}
Errores: ${{ steps.ejecutar-recordatorios.outputs.errores || '0' }}
Proxima ejecucion: $(date -d '+5 minutes' '+%H:%M:%S')

VENTANA DE ENV√çO:
- Recordatorios se env√≠an 55-65 minutos antes de la cita
- Ejemplo: Cita a las 15:00 ‚Üí Recordatorio entre 14:55 y 14:05
LOGFILE_EOF
        
        echo "üìÑ Log guardado en: $LOG_FILE"
    
    - name: üì§ Subir logs como artefacto
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: recordatorios-logs-${{ github.run_id }}
        path: recordatorios-*.log
        retention-days: 30
    
    - name: üö® Notificar en caso de error
      if: failure()
      run: |
        echo "üö® ===== ERROR EN RECORDATORIOS ====="
        echo "üìç UBICACI√ìN: Yucat√°n"
        echo "üïê Hora del error: $(date '+%H:%M:%S')"
        echo "üì§ Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code || 'Desconocido' }}"
        echo "üîç Workflow: ${{ github.workflow }}"
        echo ""
        echo "üìã Posibles causas:"
        echo "1. ‚ùå SUPABASE_SERVICE_ROLE_KEY incorrecta o no configurada"
        echo "2. ‚ùå Edge Function no desplegada en Supabase"
        echo "3. ‚ùå Problemas de conexi√≥n con EmailJS"
        echo "4. ‚ùå No hay citas para hoy"
        echo ""
        echo "üîß Acciones recomendadas:"
        echo "1. Verificar secret en GitHub: Settings > Secrets > Actions"
        echo "2. Revisar logs de Edge Function en Supabase Dashboard"
        echo "3. Ejecutar funci√≥n manualmente para testing"
        echo "4. Verificar que hay citas para hoy en la BD"