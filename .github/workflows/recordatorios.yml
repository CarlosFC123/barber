name: ğŸ“§ Recordatorios AutomÃ¡ticos

on:
  schedule:
    # Ejecutar cada 1 minuto (segÃºn UTC)
    - cron: '*/1 * * * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:

env:
  SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
  TZ: 'America/Mexico_City'

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    env:
      TZ: 'America/Mexico_City'
    
    steps:
    - name: ğŸ” Verificar configuraciÃ³n
      run: |
        echo "ğŸ• Iniciando envÃ­o de recordatorios"
        echo "ğŸ“… Fecha local (MX): $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“… Fecha UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“ Zona horaria configurada: $TZ"
        echo "ğŸ”— Supabase URL: ${{ env.SUPABASE_URL }}"
        
        # Calcular hora exacta para recordatorios (1 hora antes)
        HORA_ACTUAL_MX=$(TZ='America/Mexico_City' date '+%H:%M')
        HORA_MAS_1_HORA=$(TZ='America/Mexico_City' date -d '+1 hour' '+%H:%M')
        echo "â° Hora actual (MX): $HORA_ACTUAL_MX"
        echo "â° Hora +1 hora (MX): $HORA_MAS_1_HORA"
    
    - name: ğŸ“ Llamar a funciÃ³n de recordatorios
      id: ejecutar-recordatorios
      env:
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "ğŸ“§ Ejecutando funciÃ³n de recordatorios..."
        
        # Verificar que la key estÃ¡ configurada
        if [ -z "$SUPABASE_KEY" ]; then
          echo "âŒ ERROR: SUPABASE_SERVICE_ROLE_KEY no estÃ¡ configurada"
          exit 1
        fi
        
        # URL completa de la funciÃ³n
        FUNCTION_URL="${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos"
        echo "ğŸŒ URL de funciÃ³n: $FUNCTION_URL"
        
        # Crear timestamp en hora de Mexico - IMPORTANTE: ENVIAR LA HORA EXACTA
        TIMESTAMP_MX=$(TZ='America/Mexico_City' date '+%Y-%m-%dT%H:%M:%S')
        HORA_ACTUAL=$(TZ='America/Mexico_City' date '+%H:%M')
        echo "ğŸ• Timestamp Mexico: $TIMESTAMP_MX"
        echo "â° Hora actual exacta (MX): $HORA_ACTUAL"
        
        # Calcular ventana de 1 hora
        HORA_INICIO=$(TZ='America/Mexico_City' date -d '55 minutes' '+%H:%M')
        HORA_FIN=$(TZ='America/Mexico_City' date -d '65 minutes' '+%H:%M')
        echo "ğŸ“Š Ventana de envÃ­o: $HORA_INICIO a $HORA_FIN"
        
        # Hacer la peticiÃ³n CON MÃS INFORMACIÃ“N
        response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
          -X POST "$FUNCTION_URL" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Recordatorios/1.0" \
          --max-time 300 \
          --retry 3 \
          --retry-delay 10 \
          -d "{
            \"source\": \"github-actions\",
            \"timestamp_mx\": \"$TIMESTAMP_MX\",
            \"hora_actual_mx\": \"$HORA_ACTUAL\",
            \"ventana_inicio\": \"$HORA_INICIO\",
            \"ventana_fin\": \"$HORA_FIN\",
            \"modo\": \"automatico\"
          }")
        
        # Extraer cÃ³digo HTTP
        http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_CODE:/d')
        
        echo "ğŸ“Š CÃ³digo HTTP: $http_code"
        echo "ğŸ“¦ Respuesta completa:"
        echo "$body" | jq . 2>/dev/null || echo "$body"
        
        # Guardar salidas
        echo "http_code=$http_code" >> $GITHUB_OUTPUT
        
        # Extraer datos de la respuesta
        if [ ! -z "$body" ]; then
          total_citas=$(echo "$body" | grep -o '"total_citas":[0-9]*' | cut -d: -f2 || echo "0")
          enviados=$(echo "$body" | grep -o '"recordatorios_enviados":[0-9]*' | cut -d: -f2 || echo "0")
          errores=$(echo "$body" | grep -o '"errores":[0-9]*' | cut -d: -f2 || echo "0")
          
          echo "total_citas=$total_citas" >> $GITHUB_OUTPUT
          echo "enviados=$enviados" >> $GITHUB_OUTPUT
          echo "errores=$errores" >> $GITHUB_OUTPUT
        fi
        
        # Verificar Ã©xito
        if [ "$http_code" = "200" ]; then
          echo "âœ… Ã‰xito - Recordatorios procesados"
          exit 0
        else
          echo "âŒ Error HTTP: $http_code"
          echo "ğŸ” Error details: $body"
          exit 1
        fi
    
    - name: ğŸ“Š Generar reporte
      if: always()
      run: |
        echo "=========================================="
        echo "     REPORTE DE RECORDATORIOS"
        echo "=========================================="
        echo "ğŸ• EjecuciÃ³n iniciada (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ• EjecuciÃ³n iniciada (MX): $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“… Hoy es: $(TZ='America/Mexico_City' date '+%A, %d de %B de %Y')"
        echo "â° Hora exacta (MX): $(TZ='America/Mexico_City' date '+%H:%M:%S')"
        echo "ğŸ”§ Workflow: ${{ github.workflow }}"
        echo "ğŸ¯ Trigger: ${{ github.event_name }}"
        echo "ğŸ“¤ Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code }}"
        echo "ğŸ“Š Citas evaluadas: ${{ steps.ejecutar-recordatorios.outputs.total_citas }}"
        echo "âœ… Emails enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados }}"
        echo "âŒ Errores: ${{ steps.ejecutar-recordatorios.outputs.errores }}"
        echo "â° PrÃ³xima ejecuciÃ³n: En 1 minuto"
        echo "=========================================="
        
        # Crear archivo de log
        LOG_FILE="recordatorios-$(TZ='America/Mexico_City' date '+%Y%m%d-%H%M%S').log"
        {
          echo "# Reporte de Recordatorios"
          echo "Fecha (Mexico): $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
          echo "Hora exacta: $(TZ='America/Mexico_City' date '+%H:%M:%S')"
          echo "Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code }}"
          echo "Citas evaluadas: ${{ steps.ejecutar-recordatorios.outputs.total_citas }}"
          echo "Emails enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados }}"
          echo "Errores: ${{ steps.ejecutar-recordatorios.outputs.errores }}"
        } > $LOG_FILE
        
        echo "ğŸ“„ Log guardado en: $LOG_FILE"
    
    - name: ğŸ“¤ Subir logs como artefacto
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: recordatorios-logs
        path: recordatorios-*.log
        retention-days: 7
    
    - name: ğŸš¨ Notificar en caso de error crÃ­tico
      if: failure()
      run: |
        echo "ğŸš¨ ATENCIÃ“N: El proceso de recordatorios fallÃ³"
        echo "ğŸ• Hora del error (MX): $(TZ='America/Mexico_City' date '+%H:%M:%S')"
        echo "ğŸ“¤ Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code }}"
        echo "ğŸ” Revisar los logs de la Edge Function en Supabase"
        echo "ğŸ“§ Verificar que la Service Role Key sea correcta"
        echo "ğŸ”„ Comprobar que la funciÃ³n 'recordatorios-automaticos' existe y estÃ¡ desplegada"
        echo "â° Verificar zona horaria (debe ser America/Mexico_City)"