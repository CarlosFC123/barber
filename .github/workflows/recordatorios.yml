# .github/workflows/recordatorios.yml
name: ğŸ“§ Recordatorios AutomÃ¡ticos - DEPURACIÃ“N

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:  # Permite ejecuciÃ³n manual

env:
  SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
  TZ: 'America/Mexico_City'

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” CONFIGURACIÃ“N INICIAL
      run: |
        echo "ğŸš€ INICIANDO WORKFLOW DE DEPURACIÃ“N"
        echo "========================================"
        echo "ğŸ†” Run ID: ${{ github.run_id }}"
        echo "ğŸ”„ Run Number: ${{ github.run_number }}"
        echo "âš¡ Trigger: ${{ github.event_name }}"
        echo "ğŸ“… Hora del sistema: $(date)"
        echo "ğŸŒ Zona horaria: $TZ"
        echo "ğŸ• Hora Mexico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================"
        
        # Verificar que las secrets existen
        if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
          echo "âœ… SUPABASE_SERVICE_ROLE_KEY: CONFIGURADA"
          echo "   Longitud: ${#SUPABASE_SERVICE_ROLE_KEY} caracteres"
        else
          echo "âŒ SUPABASE_SERVICE_ROLE_KEY: NO CONFIGURADA"
          exit 1
        fi

    - name: ğŸ“ EJECUTAR FUNCIÃ“N DE RECORDATORIOS
      id: ejecutar
      env:
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "ğŸ“ LLAMANDO A EDGE FUNCTION..."
        echo "URL: ${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos"
        
        # Crear timestamp
        TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%S')
        echo "Timestamp: $TIMESTAMP"
        
        # Hacer la peticiÃ³n con verbose
        response=$(curl -v \
          -X POST "${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          -H "X-Debug-Mode: true" \
          -H "User-Agent: GitHub-Actions-Debug/1.0" \
          --max-time 30 \
          -d "{\"debug\": true, \"timestamp\": \"$TIMESTAMP\"}" \
          2>&1)
        
        # Extraer informaciÃ³n
        echo "========================================"
        echo "RAW RESPONSE:"
        echo "$response"
        echo "========================================"
        
        # Extraer HTTP code
        http_code=$(echo "$response" | grep -o "HTTP/.*" | tail -1 | awk '{print $2}')
        body=$(echo "$response" | sed -n '/^{/,/^}/p')
        
        echo "HTTP CODE: $http_code"
        echo "BODY: $body"
        
        # Guardar outputs
        echo "http_code=$http_code" >> $GITHUB_OUTPUT
        
        # Procesar respuesta JSON
        if [ ! -z "$body" ]; then
          echo "$body" > response.json
          
          total_citas=$(jq -r '.total_citas // 0' response.json)
          enviados=$(jq -r '.recordatorios_enviados // 0' response.json)
          errores=$(jq -r '.errores // 0' response.json)
          success=$(jq -r '.success // false' response.json)
          
          echo "total_citas=$total_citas" >> $GITHUB_OUTPUT
          echo "enviados=$enviados" >> $GITHUB_OUTPUT
          echo "errores=$errores" >> $GITHUB_OUTPUT
          echo "success=$success" >> $GITHUB_OUTPUT
          
          # Mostrar detalles
          echo "========================================"
          echo "RESUMEN:"
          echo "  Success: $success"
          echo "  Total citas: $total_citas"
          echo "  Enviados: $enviados"
          echo "  Errores: $errores"
          
          # Si hay error, mostrar detalles
          if [ "$success" = "false" ]; then
            error_msg=$(jq -r '.error // "Sin mensaje"' response.json)
            echo "âŒ ERROR: $error_msg"
          fi
        fi

    - name: ğŸ“Š GENERAR REPORTE DETALLADO
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“‹ REPORTE COMPLETO"
        echo "========================================"
        echo "ğŸ·ï¸ Workflow: ${{ github.workflow }}"
        echo "ğŸ†” Run ID: ${{ github.run_id }}"
        echo "ğŸ¯ Trigger: ${{ github.event_name }}"
        echo "ğŸ• Inicio (UTC): ${{ github.event.created_at }}"
        echo "ğŸ“ Repository: ${{ github.repository }}"
        echo ""
        echo "ğŸ“Š RESULTADOS:"
        echo "  Status HTTP: ${{ steps.ejecutar.outputs.http_code }}"
        echo "  Ã‰xito: ${{ steps.ejecutar.outputs.success }}"
        echo "  Citas evaluadas: ${{ steps.ejecutar.outputs.total_citas }}"
        echo "  Emails enviados: ${{ steps.ejecutar.outputs.enviados }}"
        echo "  Errores: ${{ steps.ejecutar.outputs.errores }}"
        echo ""
        echo "â° PRÃ“XIMA EJECUCIÃ“N:"
        echo "  En 5 minutos segÃºn cron"
        echo "  $(TZ='America/Mexico_City' date -d '+5 minutes' '+%H:%M:%S') hora Mexico"
        echo "========================================"
        
        # Crear archivo de log
        LOG_FILE="recordatorios-debug-$(date '+%Y%m%d-%H%M%S').log"
        echo "# Reporte de DepuraciÃ³n" > $LOG_FILE
        echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $LOG_FILE
        echo "Fecha Mexico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')" >> $LOG_FILE
        echo "Workflow: ${{ github.workflow }}" >> $LOG_FILE
        echo "Run ID: ${{ github.run_id }}" >> $LOG_FILE
        echo "Status HTTP: ${{ steps.ejecutar.outputs.http_code }}" >> $LOG_FILE
        echo "Success: ${{ steps.ejecutar.outputs.success }}" >> $LOG_FILE
        echo "Citas: ${{ steps.ejecutar.outputs.total_citas }}" >> $LOG_FILE
        echo "Enviados: ${{ steps.ejecutar.outputs.enviados }}" >> $LOG_FILE
        echo "Errores: ${{ steps.ejecutar.outputs.errores }}" >> $LOG_FILE
        
        echo "ğŸ“„ Log guardado: $LOG_FILE"

    - name: ğŸ“¤ SUBIR LOGS
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: recordatorios-debug-logs
        path: recordatorios-*.log
        retention-days: 30

    - name: ğŸš¨ NOTIFICAR ERRORES
      if: failure()
      run: |
        echo "ğŸš¨ğŸš¨ğŸš¨ ERROR CRÃTICO ğŸš¨ğŸš¨ğŸš¨"
        echo "================================"
        echo "El workflow ha fallado!"
        echo ""
        echo "PASOS PARA DEPURAR:"
        echo "1. Verificar que SUPABASE_SERVICE_ROLE_KEY sea correcta"
        echo "2. Comprobar que la Edge Function estÃ¡ desplegada"
        echo "3. Revisar logs de Supabase Functions"
        echo "4. Verificar zona horaria en citas"
        echo "5. Comprobar emails de clientes en BD"
        echo ""
        echo "ğŸ“Š Datos del error:"
        echo "HTTP Code: ${{ steps.ejecutar.outputs.http_code }}"
        echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"