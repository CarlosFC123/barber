name: Enviar Recordatorios de Citas

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  SUPABASE_URL: https://nllllvztipbrhryzxamm.supabase.co
  SUPABASE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sbGxsdnp0aXBicmhyeXp4YW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTkxMjMsImV4cCI6MjA3ODczNTEyM30.mg8mx2ACsG1VDqjt8jw_DyzU6v1aT8rRdpS0ByBGRq4
  SENDGRID_TEMPLATE_ID: d-8c34868a760f46ae987cc04944d697a0

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configurar zona horaria
        run: |
          echo "Hora YucatÃ¡n: $(TZ='America/Merida' date)"
      
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Obtener citas para hoy
        id: obtener-citas
        run: |
          FECHA_HOY=$(TZ='America/Merida' date +'%Y-%m-%d')
          HORA_ACTUAL=$(TZ='America/Merida' date +'%H:%M')
          
          echo "Fecha: $FECHA_HOY"
          echo "Hora: $HORA_ACTUAL"
          
          RESPONSE=$(curl -s -X GET \
            "${{ env.SUPABASE_URL }}/rest/v1/citas?fecha=eq.$FECHA_HOY&estado=in.(aceptada,pendiente,confirmada)&recordatorio_enviado=eq.false&select=id,fecha,hora,cliente_id,servicio_id,barbero_id" \
            -H "apikey: ${{ env.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
            -H "Content-Type: application/json")
          
          echo "CITAS_JSON=$RESPONSE" >> $GITHUB_OUTPUT
          echo "FECHA_HOY=$FECHA_HOY" >> $GITHUB_OUTPUT
          echo "HORA_ACTUAL=$HORA_ACTUAL" >> $GITHUB_OUTPUT
      
      - name: Procesar y enviar recordatorios
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          FECHA_HOY="${{ steps.obtener-citas.outputs.FECHA_HOY }}"
          HORA_ACTUAL="${{ steps.obtener-citas.outputs.HORA_ACTUAL }}"
          CITAS_JSON='${{ steps.obtener-citas.outputs.CITAS_JSON }}'
          
          if [ "$CITAS_JSON" = "[]" ] || [ -z "$CITAS_JSON" ]; then
            echo "No hay citas"
            exit 0
          fi
          
          # FunciÃ³n para crear JSON
          crear_json_sendgrid() {
            local EMAIL="$1"
            local NOMBRE="$2"
            local SERVICIO="$3"
            local FECHA="$4"
            local HORA="$5"
            local BARBERO="$6"
            local MINUTOS="$7"
            local DURACION="$8"
            
            # Escapar caracteres especiales para JSON
            local NOMBRE_ESC=$(echo "$NOMBRE" | sed 's/"/\\"/g')
            local SERVICIO_ESC=$(echo "$SERVICIO" | sed 's/"/\\"/g')
            local FECHA_ESC=$(echo "$FECHA" | sed 's/"/\\"/g')
            local BARBERO_ESC=$(echo "$BARBERO" | sed 's/"/\\"/g')
            local DURACION_ESC=$(echo "$DURACION" | sed 's/"/\\"/g')
            
            # Construir JSON manualmente
            echo '{'
            echo '  "personalizations": [{'
            echo '    "to": [{"email": "'"$EMAIL"'", "name": "'"$NOMBRE_ESC"'"}],'
            echo '    "dynamic_template_data": {'
            echo '      "cliente_nombre": "'"$NOMBRE_ESC"'",'
            echo '      "servicio_nombre": "'"$SERVICIO_ESC"'",'
            echo '      "fecha_cita": "'"$FECHA_ESC"'",'
            echo '      "hora_cita": "'"$HORA"'",'
            echo '      "barbero_nombre": "'"$BARBERO_ESC"'",'
            echo '      "direccion_barberia": "Calle 24-A, Tzucacab, YucatÃ¡n",'
            echo '      "google_maps_link": "https://maps.google.com/?q=20.063818,-89.0476701",'
            echo '      "minutos_restantes": '$MINUTOS','
            echo '      "duracion_servicio": "'"$DURACION_ESC"'",'
            echo '      "mensaje_recordatorio": "â° Recordatorio: Tu cita es dentro de '$MINUTOS' minutos"'
            echo '    },'
            echo '    "subject": "â° Recordatorio de Cita - Waldos Barber-Shop"'
            echo '  }],'
            echo '  "from": {"email": "notificaciones@waldosbarber.com", "name": "Waldos Barber-Shop"},'
            echo '  "reply_to": {"email": "notificaciones@waldosbarber.com", "name": "Waldos Barber-Shop"},'
            echo '  "template_id": "'"${{ env.SENDGRID_TEMPLATE_ID }}"'"'
            echo '}'
          }
          
          echo "$CITAS_JSON" | jq -c '.[]' | while read CITA; do
            ID=$(echo $CITA | jq -r '.id')
            HORA_CITA=$(echo $CITA | jq -r '.hora')
            CLIENTE_ID=$(echo $CITA | jq -r '.cliente_id')
            SERVICIO_ID=$(echo $CITA | jq -r '.servicio_id')
            BARBERO_ID=$(echo $CITA | jq -r '.barbero_id')
            
            echo "Cita ID: $ID - Hora: $HORA_CITA"
            
            # Obtener datos del cliente
            CLIENTE=$(curl -s -X GET \
              "${{ env.SUPABASE_URL }}/rest/v1/clientes?id=eq.$CLIENTE_ID&select=email,nombre" \
              -H "apikey: ${{ env.SUPABASE_KEY }}" \
              -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
              -H "Content-Type: application/json" | jq -r '.[0]')
            
            EMAIL=$(echo $CLIENTE | jq -r '.email')
            NOMBRE=$(echo $CLIENTE | jq -r '.nombre // "Cliente"')
            
            if [ -z "$EMAIL" ] || [ "$EMAIL" = "null" ]; then
              echo "Email no vÃ¡lido"
              continue
            fi
            
            echo "Cliente: $NOMBRE"
            echo "Email: $EMAIL"
            
            # Obtener datos del servicio
            SERVICIO=$(curl -s -X GET \
              "${{ env.SUPABASE_URL }}/rest/v1/servicios?id=eq.$SERVICIO_ID&select=nombre,duracion" \
              -H "apikey: ${{ env.SUPABASE_KEY }}" \
              -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
              -H "Content-Type: application/json" | jq -r '.[0]')
            
            SERVICIO_NOMBRE=$(echo $SERVICIO | jq -r '.nombre // "Corte"')
            DURACION=$(echo $SERVICIO | jq -r '.duracion // "30 min"')
            
            # Obtener datos del barbero
            BARBERO=$(curl -s -X GET \
              "${{ env.SUPABASE_URL }}/rest/v1/barberos?id=eq.$BARBERO_ID&select=nombre" \
              -H "apikey: ${{ env.SUPABASE_KEY }}" \
              -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
              -H "Content-Type: application/json" | jq -r '.[0]')
            
            BARBERO_NOMBRE=$(echo $BARBERO | jq -r '.nombre // "Barbero"')
            
            # Calcular minutos
            HORA_ACTUAL_MIN=$((10#${HORA_ACTUAL:0:2} * 60 + 10#${HORA_ACTUAL:3:2}))
            HORA_CITA_MIN=$((10#${HORA_CITA:0:2} * 60 + 10#${HORA_CITA:3:2}))
            MINUTOS=$((HORA_CITA_MIN - HORA_ACTUAL_MIN))
            
            echo "Minutos restantes: $MINUTOS"
            
            if [ $MINUTOS -ge 55 ] && [ $MINUTOS -le 65 ]; then
              echo "Enviando recordatorio..."
              
              # Formatear fecha
              DIA=$(TZ='America/Merida' date -d "$FECHA_HOY" '+%d')
              MES_NUM=$(TZ='America/Merida' date -d "$FECHA_HOY" '+%m')
              ANIO=$(TZ='America/Merida' date -d "$FECHA_HOY" '+%Y')
              
              case $MES_NUM in
                "01") MES="Enero";;
                "02") MES="Febrero";;
                "03") MES="Marzo";;
                "04") MES="Abril";;
                "05") MES="Mayo";;
                "06") MES="Junio";;
                "07") MES="Julio";;
                "08") MES="Agosto";;
                "09") MES="Septiembre";;
                "10") MES="Octubre";;
                "11") MES="Noviembre";;
                "12") MES="Diciembre";;
                *) MES="";;
              esac
              
              FECHA_BONITA="$DIA de $MES de $ANIO"
              
              # Crear JSON usando la funciÃ³n
              JSON_DATA=$(crear_json_sendgrid "$EMAIL" "$NOMBRE" "$SERVICIO_NOMBRE" "$FECHA_BONITA" "$HORA_CITA" "$BARBERO_NOMBRE" "$MINUTOS" "$DURACION")
              
              # Guardar JSON a archivo
              echo "$JSON_DATA" > /tmp/sendgrid_$ID.json
              
              # Enviar a SendGrid
              RESPONSE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                -X POST "https://api.sendgrid.com/v3/mail/send" \
                -H "Authorization: Bearer $SENDGRID_API_KEY" \
                -H "Content-Type: application/json" \
                -d @/tmp/sendgrid_$ID.json)
              
              if [ "$RESPONSE" = "202" ]; then
                echo "âœ… Email enviado"
                
                # Marcar como enviado
                curl -s -X PATCH "${{ env.SUPABASE_URL }}/rest/v1/citas?id=eq.$ID" \
                  -H "apikey: ${{ env.SUPABASE_KEY }}" \
                  -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                  -d '{"recordatorio_enviado": true}'
              else
                echo "âŒ Error: $RESPONSE"
                cat /tmp/response.txt 2>/dev/null
              fi
              
              rm -f /tmp/sendgrid_$ID.json /tmp/response.txt
              sleep 2
            fi
          done
      
      - name: Finalizar
        run: |
          echo "âœ… Proceso completado"
          echo "ğŸ• $(TZ='America/Merida' date)"