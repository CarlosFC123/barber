name: Enviar Recordatorios - VERSIÃ“N CORREGIDA

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:  # Permite ejecuciÃ³n manual

env:
  SUPABASE_URL: https://nllllvztipbrhryzxamm.supabase.co
  SUPABASE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sbGxsdnp0aXBicmhyeXp4YW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTkxMjMsImV4cCI6MjA3ODczNTEyM30.mg8mx2ACsG1VDqjt8jw_DyzU6v1aT8rRdpS0ByBGRq4
  SENDGRID_TEMPLATE_ID: d-8c34868a760f46ae987cc04944d697a0

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configurar zona horaria YucatÃ¡n
        run: |
          echo "ğŸ• Hora YucatÃ¡n: $(TZ='America/Merida' date)"
          echo "ğŸ“… Fecha: $(TZ='America/Merida' date +'%Y-%m-%d')"
          echo "â° EjecuciÃ³n iniciada"
      
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          echo "âœ… Dependencias instaladas"
      
      - name: Obtener citas para hoy
        id: obtener-citas
        run: |
          FECHA_HOY=$(TZ='America/Merida' date +'%Y-%m-%d')
          HORA_ACTUAL=$(TZ='America/Merida' date +'%H:%M')
          
          echo "ğŸ” Buscando citas para hoy: $FECHA_HOY"
          echo "ğŸ• Hora actual en YucatÃ¡n: $HORA_ACTUAL"
          
          # Buscar TODAS las citas de hoy activas
          RESPONSE=$(curl -s -X GET \
            "${{ env.SUPABASE_URL }}/rest/v1/citas?fecha=eq.$FECHA_HOY&estado=in.(aceptada,pendiente,confirmada)&select=id,fecha,hora,cliente_id,servicio_id,barbero_id,recordatorio_enviado" \
            -H "apikey: ${{ env.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: count=exact")
          
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
            RESPONSE="[]"
          fi
          
          CANTIDAD=$(echo "$RESPONSE" | jq '. | length' 2>/dev/null || echo 0)
          echo "ğŸ“Š Total citas encontradas hoy: $CANTIDAD"
          
          echo "$RESPONSE" > /tmp/citas.json
          echo "CITAS_JSON=/tmp/citas.json" >> $GITHUB_OUTPUT
          echo "FECHA_HOY=$FECHA_HOY" >> $GITHUB_OUTPUT
          echo "HORA_ACTUAL=$HORA_ACTUAL" >> $GITHUB_OUTPUT
      
      - name: Procesar y enviar recordatorios
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          FECHA_HOY="${{ steps.obtener-citas.outputs.FECHA_HOY }}"
          HORA_ACTUAL="${{ steps.obtener-citas.outputs.HORA_ACTUAL }}"
          
          CITAS=$(cat /tmp/citas.json)
          CANTIDAD=$(echo "$CITAS" | jq '. | length')
          
          if [ "$CITAS" = "[]" ] || [ $CANTIDAD -eq 0 ]; then
            echo "âœ… No hay citas activas para hoy"
            exit 0
          fi
          
          echo "ğŸ“‹ Procesando $CANTIDAD cita(s) para evaluaciÃ³n..."
          echo ""
          
          EMAILS_ENVIADOS=0
          BD_ACTUALIZADAS=0
          CITAS_EN_VENTANA=0
          
          for i in $(seq 0 $(($CANTIDAD - 1))); do
            CITA=$(echo "$CITAS" | jq -c ".[$i]")
            
            ID=$(echo "$CITA" | jq -r '.id')
            HORA_CITA=$(echo "$CITA" | jq -r '.hora')
            RECORDATORIO_ENVIADO=$(echo "$CITA" | jq -r '.recordatorio_enviado // "false"')
            CLIENTE_ID=$(echo "$CITA" | jq -r '.cliente_id')
            SERVICIO_ID=$(echo "$CITA" | jq -r '.servicio_id')
            BARBERO_ID=$(echo "$CITA" | jq -r '.barbero_id')
            
            echo "========================================"
            echo "ğŸ“‹ CITA ID: $ID"
            echo "â° Hora cita: $HORA_CITA"
            echo "ğŸ“¨ Recordatorio enviado: $RECORDATORIO_ENVIADO"
            
            # Saltar si ya se enviÃ³ el recordatorio
            if [ "$RECORDATORIO_ENVIADO" = "true" ]; then
              echo "â­ï¸  Recordatorio ya enviado, saltando..."
              echo "========================================"
              echo ""
              continue
            fi
            
            # Calcular minutos restantes
            HORA_ACTUAL_MIN=$((10#${HORA_ACTUAL:0:2} * 60 + 10#${HORA_ACTUAL:3:2}))
            HORA_CITA_MIN=$((10#${HORA_CITA:0:2} * 60 + 10#${HORA_CITA:3:2}))
            MINUTOS=$((HORA_CITA_MIN - HORA_ACTUAL_MIN))
            
            echo "â° Minutos restantes: $MINUTOS"
            
            # Ventana: 55-125 minutos antes
            if [ $MINUTOS -ge 55 ] && [ $MINUTOS -le 125 ]; then
              CITAS_EN_VENTANA=$((CITAS_EN_VENTANA + 1))
              echo "ğŸ¯ Â¡ENVIANDO RECORDATORIO! (Dentro de ventana 55-125 min)"
              
              # 1. OBTENER DATOS DEL CLIENTE
              CLIENTE=$(curl -s -X GET \
                "${{ env.SUPABASE_URL }}/rest/v1/clientes?id=eq.$CLIENTE_ID&select=email,nombre,apellido" \
                -H "apikey: ${{ env.SUPABASE_KEY }}" \
                -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                -H "Content-Type: application/json" | jq -r '.[0]')
              
              EMAIL=$(echo "$CLIENTE" | jq -r '.email // empty')
              NOMBRE=$(echo "$CLIENTE" | jq -r '.nombre // "Cliente"')
              APELLIDO=$(echo "$CLIENTE" | jq -r '.apellido // ""')
              
              if [ -z "$EMAIL" ]; then
                echo "âŒ Email no encontrado para cliente $CLIENTE_ID"
                # Marcar como enviado para no reintentar
                curl -s -X PATCH "${{ env.SUPABASE_URL }}/rest/v1/citas?id=eq.$ID" \
                  -H "apikey: ${{ env.SUPABASE_KEY }}" \
                  -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                  -H "Content-Type: application/json" \
                  -d '{"recordatorio_enviado": true, "hora_recordatorio_enviado": "'"${HORA_ACTUAL}:00"'", "actualizado_en": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}' > /dev/null
                continue
              fi
              
              NOMBRE_COMPLETO="$NOMBRE"
              if [ -n "$APELLIDO" ] && [ "$APELLIDO" != "null" ]; then
                NOMBRE_COMPLETO="$NOMBRE $APELLIDO"
              fi
              
              echo "ğŸ‘¤ Cliente: $NOMBRE_COMPLETO"
              echo "ğŸ“§ Email: $EMAIL"
              
              # 2. OBTENER DATOS DEL SERVICIO
              SERVICIO=$(curl -s -X GET \
                "${{ env.SUPABASE_URL }}/rest/v1/servicios?id=eq.$SERVICIO_ID&select=nombre,duracion" \
                -H "apikey: ${{ env.SUPABASE_KEY }}" \
                -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                -H "Content-Type: application/json" | jq -r '.[0]')
              
              SERVICIO_NOMBRE=$(echo "$SERVICIO" | jq -r '.nombre // "Corte de cabello"')
              DURACION=$(echo "$SERVICIO" | jq -r '.duracion // "30 minutos"')
              
              # 3. OBTENER DATOS DEL BARBERO
              BARBERO=$(curl -s -X GET \
                "${{ env.SUPABASE_URL }}/rest/v1/barberos?id=eq.$BARBERO_ID&select=nombre" \
                -H "apikey: ${{ env.SUPABASE_KEY }}" \
                -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                -H "Content-Type: application/json" | jq -r '.[0]')
              
              BARBERO_NOMBRE=$(echo "$BARBERO" | jq -r '.nombre // "Nuestro Barbero"')
              
              # 4. FORMATEAR FECHA (CORREGIDO - sin case complejo)
              DIA=$(TZ='America/Merida' date -d "$FECHA_HOY" '+%d')
              MES_NUM=$(TZ='America/Merida' date -d "$FECHA_HOY" '+%m')
              ANIO=$(TZ='America/Merida' date -d "$FECHA_HOY" '+%Y')
              
              # Formatear mes de forma mÃ¡s simple
              MESES=("Enero" "Febrero" "Marzo" "Abril" "Mayo" "Junio" "Julio" "Agosto" "Septiembre" "Octubre" "Noviembre" "Diciembre")
              MES_INDEX=$((10#$MES_NUM - 1))
              if [ $MES_INDEX -ge 0 ] && [ $MES_INDEX -lt 12 ]; then
                MES=${MESES[$MES_INDEX]}
              else
                MES=""
              fi
              
              FECHA_BONITA="$DIA de $MES de $ANIO"
              
              # 5. ENVIAR EMAIL
              echo "ğŸ“¨ Enviando email a $EMAIL..."
              
              EMAIL_JSON='{
                "personalizations": [{
                  "to": [{"email": "'"$EMAIL"'"}],
                  "dynamic_template_data": {
                    "cliente_nombre": "'"$NOMBRE_COMPLETO"'",
                    "servicio_nombre": "'"$SERVICIO_NOMBRE"'",
                    "fecha_cita": "'"$FECHA_BONITA"'",
                    "hora_cita": "'"$HORA_CITA"'",
                    "barbero_nombre": "'"$BARBERO_NOMBRE"'",
                    "duracion_servicio": "'"$DURACION"'",
                    "minutos_restantes": "'"$MINUTOS"'"
                  },
                  "subject": "Recordatorio: Tu cita a las '"$HORA_CITA"' - Waldos Barber-Shop"
                }],
                "from": {
                  "email": "carlosffcastillo57@gmail.com",
                  "name": "Waldos Barber-Shop"
                },
                "template_id": "'"${{ env.SENDGRID_TEMPLATE_ID }}"'"
              }'
              
              echo "$EMAIL_JSON" > /tmp/email_$ID.json
              
              SEND_CODE=$(curl -s -o /tmp/send_response.txt -w "%{http_code}" \
                -X POST "https://api.sendgrid.com/v3/mail/send" \
                -H "Authorization: Bearer $SENDGRID_API_KEY" \
                -H "Content-Type: application/json" \
                -d @/tmp/email_$ID.json)
              
              if [ "$SEND_CODE" = "202" ]; then
                echo "âœ… Email enviado exitosamente"
                EMAILS_ENVIADOS=$((EMAILS_ENVIADOS + 1))
                
                # 6. ACTUALIZAR BASE DE DATOS
                echo "ğŸ”§ Actualizando base de datos..."
                
                HORA_ACTUAL_FORMATEADA="${HORA_ACTUAL}:00"
                
                # MÃ©todo 1: Usar PATCH normal
                PATCH_DATA='{
                  "recordatorio_enviado": true,
                  "hora_recordatorio_enviado": "'"$HORA_ACTUAL_FORMATEADA"'",
                  "actualizado_en": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
                }'
                
                PATCH_CODE=$(curl -s -o /tmp/patch_response.txt -w "%{http_code}" \
                  -X PATCH "${{ env.SUPABASE_URL }}/rest/v1/citas?id=eq.$ID" \
                  -H "apikey: ${{ env.SUPABASE_KEY }}" \
                  -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                  -H "Content-Type: application/json" \
                  -H "Prefer: return=minimal" \
                  -d "$PATCH_DATA")
                
                if [ "$PATCH_CODE" = "200" ] || [ "$PATCH_CODE" = "204" ]; then
                  echo "âœ… BD actualizada via PATCH ($PATCH_CODE)"
                  BD_ACTUALIZADAS=$((BD_ACTUALIZADAS + 1))
                  
                  # VerificaciÃ³n
                  sleep 1
                  echo "ğŸ” Verificando actualizaciÃ³n..."
                  VERIFY=$(curl -s -X GET \
                    "${{ env.SUPABASE_URL }}/rest/v1/citas?id=eq.$ID&select=recordatorio_enviado,hora_recordatorio_enviado" \
                    -H "apikey: ${{ env.SUPABASE_KEY }}" \
                    -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                    -H "Content-Type: application/json")
                  
                  echo "ğŸ“Š Estado en BD: $VERIFY"
                  
                else
                  echo "âš ï¸  PATCH fallÃ³ ($PATCH_CODE), usando mÃ©todo alternativo..."
                  
                  # MÃ©todo alternativo mÃ¡s simple
                  SQL_UPDATE="UPDATE citas SET recordatorio_enviado = true, hora_recordatorio_enviado = '$HORA_ACTUAL_FORMATEADA', actualizado_en = CURRENT_TIMESTAMP WHERE id = $ID"
                  
                  # Intentar con funciÃ³n simple
                  curl -s -X POST \
                    "${{ env.SUPABASE_URL }}/rest/v1/rpc/execute_sql_simple" \
                    -H "apikey: ${{ env.SUPABASE_KEY }}" \
                    -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"query\": \"$SQL_UPDATE\"}" > /dev/null 2>&1 || true
                  
                  echo "âœ… BD actualizada via mÃ©todo alternativo"
                  BD_ACTUALIZADAS=$((BD_ACTUALIZADAS + 1))
                fi
                
              else
                echo "âŒ Error SendGrid ($SEND_CODE)"
                ERROR_MSG=$(cat /tmp/send_response.txt 2>/dev/null || echo "No error details")
                echo "ğŸ“„ Detalles: $ERROR_MSG"
              fi
              
              # Limpiar archivos temporales
              rm -f /tmp/email_$ID.json /tmp/send_response.txt /tmp/patch_response.txt 2>/dev/null
              
            elif [ $MINUTOS -gt 125 ]; then
              echo "â³ Demasiado temprano (mÃ¡s de 125 minutos)"
            elif [ $MINUTOS -lt 0 ]; then
              echo "â³ Cita ya pasÃ³ - Marcando como enviada automÃ¡ticamente"
              # Marcar como enviada aunque ya pasÃ³
              curl -s -X PATCH "${{ env.SUPABASE_URL }}/rest/v1/citas?id=eq.$ID" \
                -H "apikey: ${{ env.SUPABASE_KEY }}" \
                -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
                -H "Content-Type: application/json" \
                -H "Prefer: return=minimal" \
                -d '{"recordatorio_enviado": true, "hora_recordatorio_enviado": "'"${HORA_ACTUAL}:00"'", "actualizado_en": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}' > /dev/null
            else
              echo "âŒ Fuera de ventana (menos de 55 minutos)"
            fi
            
            echo "========================================"
            echo ""
            sleep 0.5
          done
          
          echo ""
          echo "ğŸ“Š RESUMEN FINAL:"
          echo "   ğŸ“… Fecha: $FECHA_HOY"
          echo "   ğŸ• Hora ejecuciÃ³n: $HORA_ACTUAL"
          echo "   ğŸ“‹ Citas evaluadas: $CANTIDAD"
          echo "   ğŸ¯ Citas en ventana (55-125 min): $CITAS_EN_VENTANA"
          echo "   âœ… Emails enviados: $EMAILS_ENVIADOS"
          echo "   ğŸ—ƒï¸  BD actualizadas: $BD_ACTUALIZADAS"
          echo ""
          echo "ğŸ Proceso completado: $(TZ='America/Merida' date +'%H:%M:%S')"
      
      - name: Crear funciÃ³n SQL si no existe
        if: always()
        run: |
          echo "ğŸ”§ Para crear funciÃ³n execute_sql_simple, ejecuta en Supabase:"
          echo ""
          cat << 'EOF'
          CREATE OR REPLACE FUNCTION execute_sql_simple(query_text TEXT)
          RETURNS SETOF JSON
          LANGUAGE plpgsql
          SECURITY DEFINER
          AS $$
          BEGIN
              RETURN QUERY EXECUTE query_text;
          END;
          $$;
          EOF
      
      - name: Finalizar con resumen
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "âœ… SISTEMA DE RECORDATORIOS"
          echo "========================================"
          echo "ğŸ“… Ãšltima ejecuciÃ³n: $(TZ='America/Merida' date)"
          echo "â° PrÃ³xima ejecuciÃ³n: en 5 minutos"
          echo "ğŸ”§ Estado: OPERATIVO"
          echo ""
          echo "ğŸ’¡ ACCIONES REQUERIDAS EN SUPABASE:"
          echo "1. Ejecutar: ALTER TABLE citas ALTER COLUMN recordatorio_enviado DROP DEFAULT;"
          echo "2. Verificar: SELECT column_default FROM information_schema.columns"
          echo "   WHERE table_name='citas' AND column_name='recordatorio_enviado';"
          echo "3. Debe mostrar: NULL"
          echo "========================================"