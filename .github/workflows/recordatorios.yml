name: üìß Recordatorios Autom√°ticos

on:
  schedule:
    # Ejecutar cada 5 minutos (formato corregido)
    - cron: '*/5 * * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub
  workflow_dispatch:

env:
  SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Verificar configuraci√≥n
      run: |
        echo "üïê Iniciando env√≠o de recordatorios"
        echo "üìÖ Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "üìç Zona horaria: $(date '+%Z')"
        echo "üîó Supabase URL: ${{ env.SUPABASE_URL }}"
    
    - name: üìû Llamar a funci√≥n de recordatorios
      id: ejecutar-recordatorios
      env:
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "üìß Ejecutando funci√≥n de recordatorios..."
        echo "üîë Key disponible: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY != '' }}"
        
        # Verificar que la key est√° configurada
        if [ -z "$SUPABASE_KEY" ]; then
          echo "‚ùå ERROR: SUPABASE_SERVICE_ROLE_KEY no est√° configurada"
          exit 1
        fi
        
        # URL completa de la funci√≥n
        FUNCTION_URL="${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos"
        echo "üåê URL de funci√≥n: $FUNCTION_URL"
        
        # Hacer la petici√≥n
        set +e  # No salir en error inmediatamente
        
        response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
          -X POST "$FUNCTION_URL" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          --max-time 180 \
          --retry 2 \
          --retry-delay 5 \
          -d '{"source": "github-actions", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}')
        
        # Extraer c√≥digo HTTP y respuesta
        http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_CODE:/d')
        
        echo "üìä C√≥digo HTTP: $http_code"
        
        # Guardar salidas
        echo "http_code=$http_code" >> $GITHUB_OUTPUT
        echo "response_body<<EOF" >> $GITHUB_OUTPUT
        echo "$body" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Extraer datos de la respuesta
        if [ ! -z "$body" ]; then
          total_citas=$(echo "$body" | grep -o '"total_citas":[0-9]*' | cut -d: -f2 || echo "0")
          enviados=$(echo "$body" | grep -o '"recordatorios_enviados":[0-9]*' | cut -d: -f2 || echo "0")
          errores=$(echo "$body" | grep -o '"errores":[0-9]*' | cut -d: -f2 || echo "0")
          
          echo "total_citas=$total_citas" >> $GITHUB_OUTPUT
          echo "enviados=$enviados" >> $GITHUB_OUTPUT
          echo "errores=$errores" >> $GITHUB_OUTPUT
        fi
        
        # Verificar √©xito
        if [ "$http_code" = "200" ]; then
          echo "‚úÖ √âxito - Recordatorios procesados"
          exit 0
        else
          echo "‚ùå Error HTTP: $http_code"
          echo "üîç Respuesta: $body"
          exit 1
        fi
    
    - name: üìä Generar reporte
      if: always()
      run: |
        echo "=========================================="
        echo "     REPORTE DE RECORDATORIOS"
        echo "=========================================="
        echo "üïê Hora ejecuci√≥n: $(date '+%H:%M:%S')"
        echo "üìÖ Fecha: $(date '+%Y-%m-%d')"
        echo "üîß Workflow: ${{ github.workflow }}"
        echo "üéØ Trigger: ${{ github.event_name }}"
        echo "üì§ Status: ${{ job.status }}"
        echo "üì§ Status HTTP: ${{ steps.ejecutar-recordatorios.outputs.http_code || 'N/A' }}"
        echo "üìä Citas evaluadas: ${{ steps.ejecutar-recordatorios.outputs.total_citas || '0' }}"
        echo "‚úÖ Emails enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados || '0' }}"
        echo "‚ùå Errores: ${{ steps.ejecutar-recordatorios.outputs.errores || '0' }}"
        echo "‚è∞ Pr√≥xima ejecuci√≥n: En 5 minutos"
        echo "=========================================="
        
        # Crear archivo de log para debugging
        echo "# Reporte de Recordatorios" > recordatorios-${{ github.run_id }}.log
        echo "Run ID: ${{ github.run_id }}" >> recordatorios-${{ github.run_id }}.log
        echo "Run Number: ${{ github.run_number }}" >> recordatorios-${{ github.run_id }}.log
        echo "Date: $(date)" >> recordatorios-${{ github.run_id }}.log
        echo "Status: ${{ job.status }}" >> recordatorios-${{ github.run_id }}.log
        
        # Subir log como artifact si falla
        if [ "${{ job.status }}" = "failure" ]; then
          echo "üö® Workflow fallido - Log guardado"
        fi
    
    - name: ‚¨ÜÔ∏è Subir logs en caso de error
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: recordatorios-error-logs
        path: recordatorios-*.log
        retention-days: 7