# .github/workflows/recordatorios.yml
name: ðŸ“§ Recordatorios AutomÃ¡ticos - DEPURACIÃ“N

on:
  schedule:
    - cron: '*/1 * * * *'  # Cada 5 minutos
  workflow_dispatch:  # Permite ejecuciÃ³n manual

env:
  SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
  TZ: 'America/Mexico_City'

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” CONFIGURACIÃ“N INICIAL
      run: |
        echo "ðŸš€ INICIANDO WORKFLOW DE DEPURACIÃ“N"
        echo "========================================"
        echo "ðŸ†” Run ID: ${{ github.run_id }}"
        echo "ðŸ”„ Run Number: ${{ github.run_number }}"
        echo "âš¡ Trigger: ${{ github.event_name }}"
        echo "ðŸ“… Hora sistema: $(date)"
        echo "ðŸŒŽ Zona horaria: $TZ"
        echo "ðŸ• Hora Mexico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        echo "ðŸ”— Supabase URL: ${{ env.SUPABASE_URL }}"
        
        # Verificar secret configurada
        if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
          echo "âœ… SUPABASE_SERVICE_ROLE_KEY: CONFIGURADA"
          # Mostrar primeros y Ãºltimos caracteres para verificaciÃ³n
          KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          echo "ðŸ“Ž Key preview: ${KEY:0:20}...${KEY: -20}"
          echo "ðŸ“ Longitud: ${#KEY} caracteres"
        else
          echo "âŒ ERROR: SUPABASE_SERVICE_ROLE_KEY NO CONFIGURADA"
          echo "â„¹ï¸  Ve a: Settings â†’ Secrets and variables â†’ Actions"
          echo "â„¹ï¸  Agrega secret: SUPABASE_SERVICE_ROLE_KEY"
          exit 1
        fi

    - name: ðŸ“ž EJECUTAR FUNCIÃ“N DE RECORDATORIOS
      id: ejecutar
      env:
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "ðŸ“ž LLAMANDO A EDGE FUNCTION..."
        FUNCTION_URL="${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos"
        echo "ðŸŒ URL: $FUNCTION_URL"
        
        # Crear timestamp en hora Mexico
        TIMESTAMP_MX=$(TZ='America/Mexico_City' date '+%Y-%m-%dT%H:%M:%S')
        echo "ðŸ• Timestamp (MX): $TIMESTAMP_MX"
        
        # Verificar que la key tiene formato JWT
        echo "ðŸ”‘ Verificando Service Role Key..."
        if [[ $SUPABASE_KEY == eyJ* ]]; then
          echo "âœ… Formato JWT detectado"
        else
          echo "âŒ Formato inesperado - Â¿es la Service Role Key correcta?"
        fi
        
        echo "ðŸ“¤ Enviando peticiÃ³n a Edge Function..."
        
        # Usar curl con mejor manejo de errores
        response=$(curl -s -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}" \
          -X POST "$FUNCTION_URL" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Action: true" \
          -H "X-Trigger-Source: github-actions" \
          --max-time 60 \
          --retry 2 \
          --retry-delay 5 \
          -d "{\"debug\": true, \"timestamp_mx\": \"$TIMESTAMP_MX\", \"source\": \"github-actions\"}")
        
        # Separar partes de la respuesta
        http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
        response_time=$(echo "$response" | grep "TIME:" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_CODE:/d' | sed '/TIME:/d')
        
        echo "========================================"
        echo "ðŸ“Š RESPUESTA DE EDGE FUNCTION:"
        echo "ðŸ• Tiempo de respuesta: ${response_time}s"
        echo "ðŸ“¤ Status HTTP: $http_code"
        
        if [ ! -z "$body" ]; then
          echo "ðŸ“¦ Body (raw):"
          echo "$body"
          
          # Guardar para procesamiento JSON
          echo "$body" > response.json
          
          # Extraer datos con jq
          if command -v jq &> /dev/null; then
            echo "ðŸ“‹ Body (formateado):"
            jq . response.json
            
            success=$(jq -r '.success // false' response.json 2>/dev/null || echo "false")
            total_citas=$(jq -r '.total_citas // 0' response.json 2>/dev/null || echo "0")
            enviados=$(jq -r '.recordatorios_enviados // 0' response.json 2>/dev/null || echo "0")
            errores=$(jq -r '.errores // 0' response.json 2>/dev/null || echo "0")
            error_msg=$(jq -r '.error // empty' response.json 2>/dev/null)
            
            echo "âœ… Success: $success"
            echo "ðŸ“… Citas evaluadas: $total_citas"
            echo "ðŸ“§ Emails enviados: $enviados"
            echo "âŒ Errores: $errores"
            
            if [ ! -z "$error_msg" ]; then
              echo "âš ï¸ Error message: $error_msg"
            fi
            
            # Guardar outputs
            echo "http_code=$http_code" >> $GITHUB_OUTPUT
            echo "success=$success" >> $GITHUB_OUTPUT
            echo "total_citas=$total_citas" >> $GITHUB_OUTPUT
            echo "enviados=$enviados" >> $GITHUB_OUTPUT
            echo "errores=$errores" >> $GITHUB_OUTPUT
            
          else
            echo "âš ï¸ jq no disponible, usando extracciÃ³n bÃ¡sica"
            echo "http_code=$http_code" >> $GITHUB_OUTPUT
            echo "success=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ Respuesta vacÃ­a o error de conexiÃ³n"
          echo "http_code=$http_code" >> $GITHUB_OUTPUT
          echo "success=false" >> $GITHUB_OUTPUT
        fi
        
        # Determinar Ã©xito basado en HTTP code
        if [ "$http_code" = "200" ]; then
          echo "âœ… PeticiÃ³n exitosa (HTTP 200)"
        else
          echo "âŒ Error HTTP: $http_code"
          exit 1
        fi

    - name: ðŸ“Š GENERAR REPORTE DETALLADO
      if: always()
      run: |
        echo "========================================"
        echo "ðŸ“‹ REPORTE FINAL DE EJECUCIÃ“N"
        echo "========================================"
        echo "ðŸ·ï¸ Workflow: ${{ github.workflow }}"
        echo "ðŸ†” Run ID: ${{ github.run_id }}"
        echo "ðŸ”— Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ðŸŽ¯ Trigger: ${{ github.event_name }}"
        echo ""
        echo "â° INFORMACIÃ“N TEMPORAL:"
        echo "  Hora ejecuciÃ³n (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "  Hora ejecuciÃ³n (MX): $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        echo "  Zona horaria: ${{ env.TZ }}"
        echo ""
        echo "ðŸ“Š RESULTADOS:"
        echo "  Status HTTP: ${{ steps.ejecutar.outputs.http_code || 'N/A' }}"
        echo "  Ã‰xito: ${{ steps.ejecutar.outputs.success || 'false' }}"
        echo "  Citas evaluadas: ${{ steps.ejecutar.outputs.total_citas || '0' }}"
        echo "  Emails enviados: ${{ steps.ejecutar.outputs.enviados || '0' }}"
        echo "  Errores: ${{ steps.ejecutar.outputs.errores || '0' }}"
        echo ""
        echo "â° PRÃ“XIMA EJECUCIÃ“N:"
        echo "  Cron: '*/5 * * * *' (cada 5 minutos)"
        echo "  Hora MX: $(TZ='America/Mexico_City' date -d '+5 minutes' '+%H:%M:%S')"
        echo "========================================"
        
        # Crear log detallado
        LOG_FILE="recordatorios-$(date '+%Y%m%d-%H%M%S').log"
        
        cat > "$LOG_FILE" << EOF
# REPORTE DE RECORDATORIOS
Fecha UTC: $(date -u '+%Y-%m-%d %H:%M:%S')
Fecha Mexico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')
Workflow: ${{ github.workflow }}
Run ID: ${{ github.run_id }}
Trigger: ${{ github.event_name }}
Repository: ${{ github.repository }}

## RESULTADOS
Status HTTP: ${{ steps.ejecutar.outputs.http_code || 'N/A' }}
Success: ${{ steps.ejecutar.outputs.success || 'false' }}
Citas evaluadas: ${{ steps.ejecutar.outputs.total_citas || '0' }}
Emails enviados: ${{ steps.ejecutar.outputs.enviados || '0' }}
Errores: ${{ steps.ejecutar.outputs.errores || '0' }}

## CONFIGURACIÃ“N
Supabase URL: ${{ env.SUPABASE_URL }}
Zona horaria: ${{ env.TZ }}
Service Role Key: $(if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then echo "CONFIGURADA"; else echo "NO CONFIGURADA"; fi)

## PRÃ“XIMA EJECUCIÃ“N
ProgramaciÃ³n: Cada 5 minutos
Siguiente (MX): $(TZ='America/Mexico_City' date -d '+5 minutes' '+%H:%M:%S')
EOF
        
        echo "ðŸ“„ Log guardado en: $LOG_FILE"

    - name: ðŸ“¤ SUBIR LOGS COMO ARTEFACTO
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: recordatorios-logs
        path: recordatorios-*.log
        retention-days: 7
        if-no-files-found: warn

    - name: ðŸš¨ NOTIFICAR ERROR CRÃTICO
      if: failure()
      run: |
        echo "ðŸš¨ðŸš¨ðŸš¨ ERROR EN WORKFLOW ðŸš¨ðŸš¨ðŸš¨"
        echo "===================================="
        echo "ATENCIÃ“N: El proceso de recordatorios ha fallado"
        echo ""
        echo "ðŸ” POSIBLES CAUSAS:"
        echo "1. Service Role Key incorrecta o expirada"
        echo "2. Edge Function no desplegada"
        echo "3. Permisos insuficientes en la BD"
        echo "4. Error en la funciÃ³n edge"
        echo ""
        echo "ðŸ› ï¸  SOLUCIONES:"
        echo "â€¢ Verificar SUPABASE_SERVICE_ROLE_KEY en GitHub Secrets"
        echo "â€¢ Usar la Service Role Key (no la anon key)"
        echo "â€¢ Desplegar funciÃ³n: supabase functions deploy recordatorios-automaticos"
        echo "â€¢ Revisar logs en Supabase Dashboard â†’ Edge Functions"
        echo ""
        echo "ðŸ“Š DATOS DEL ERROR:"
        echo "HTTP Code: ${{ steps.ejecutar.outputs.http_code || 'N/A' }}"
        echo "Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"