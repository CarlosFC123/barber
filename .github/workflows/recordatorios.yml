name: ðŸ“§ Recordatorios AutomÃ¡ticos

on:
  schedule:
    # Ejecutar cada 5 minutos
    - cron: '*/3 * * * *'
  
  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:

env:
  SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
  TZ: 'America/Mexico_City'

jobs:
  enviar-recordatorios:
    runs-on: ubuntu-latest
    env:
      TZ: 'America/Mexico_City'
    
    steps:
    - name: ðŸ” Verificar configuraciÃ³n
      run: |
        echo "ðŸ• ===== INICIO DE EJECUCIÃ“N ====="
        echo "ðŸ“ UBICACIÃ“N: YucatÃ¡n, MÃ©xico"
        echo "â° Zona horaria: $TZ"
        echo "ðŸ“… Fecha/Hora MÃ©xico: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "ðŸŽ¯ VENTANA DE ENVÃO: 55-65 minutos antes de cada cita"
        echo ""
        echo "ðŸ“ EJEMPLOS:"
        echo "â€¢ Hora actual: $(date '+%H:%M')"
        echo "â€¢ Para cita 09:00 â†’ Se envÃ­a entre 07:55 y 08:05"
        echo "â€¢ Para cita 14:00 â†’ Se envÃ­a entre 12:55 y 13:05"
        echo ""
        echo "â° PrÃ³xima ejecuciÃ³n en 5 minutos: $(date -d '+5 minutes' '+%H:%M')"
    
    - name: ðŸ“ž Llamar a funciÃ³n de recordatorios
      id: ejecutar-recordatorios
      env:
        SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        echo "ðŸ“§ Ejecutando funciÃ³n de recordatorios..."
        
        if [ -z "$SUPABASE_KEY" ]; then
          echo "âŒ ERROR: SUPABASE_SERVICE_ROLE_KEY no estÃ¡ configurada"
          exit 1
        fi
        
        echo "âœ… Service Role Key configurada correctamente"
        
        # URL completa de la funciÃ³n
        FUNCTION_URL="${{ env.SUPABASE_URL }}/functions/v1/recordatorios-automaticos"
        
        # Hacer la peticiÃ³n con timeout
        response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
          -X POST "$FUNCTION_URL" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-Recordatorios/1.0" \
          --max-time 60 \
          --connect-timeout 30 \
          --retry 2 \
          --retry-delay 5)
        
        # Extraer cÃ³digo HTTP
        http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
        body=$(echo "$response" | sed '/HTTP_CODE:/d')
        
        echo "ðŸ“Š CÃ³digo HTTP: $http_code"
        
        if [ ! -z "$body" ]; then
          echo "ðŸ“¦ Respuesta JSON:"
          echo "$body" | python3 -m json.tool 2>/dev/null || echo "$body"
          
          # Extraer datos
          if echo "$body" | python3 -c "import sys,json; print(json.load(sys.stdin)['total_citas'])" 2>/dev/null; then
            total_citas=$(echo "$body" | python3 -c "import sys,json; print(json.load(sys.stdin)['total_citas'])" 2>/dev/null)
            enviados=$(echo "$body" | python3 -c "import sys,json; print(json.load(sys.stdin)['recordatorios_enviados'])" 2>/dev/null)
            errores=$(echo "$body" | python3 -c "import sys,json; print(json.load(sys.stdin)['errores'])" 2>/dev/null)
            
            echo "total_citas=$total_citas" >> $GITHUB_OUTPUT
            echo "enviados=$enviados" >> $GITHUB_OUTPUT
            echo "errores=$errores" >> $GITHUB_OUTPUT
          fi
        fi
        
        echo "http_code=$http_code" >> $GITHUB_OUTPUT
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… Ã‰xito - Recordatorios procesados"
        else
          echo "âŒ Error HTTP: $http_code"
          exit 1
        fi
    
    - name: ðŸ“Š Generar reporte
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "     ðŸ“‹ REPORTE DETALLADO - MÃ‰XICO"
        echo "=========================================="
        echo "ðŸ• Hora ejecuciÃ³n: $(date '+%H:%M:%S')"
        echo "ðŸ“… Fecha: $(date '+%Y-%m-%d')"
        echo "ðŸ“ Zona: America/Mexico_City"
        echo ""
        echo "ðŸ“Š RESULTADOS:"
        echo "â€¢ Citas evaluadas: ${{ steps.ejecutar-recordatorios.outputs.total_citas || '0' }}"
        echo "â€¢ Emails enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados || '0' }}"
        echo "â€¢ Errores: ${{ steps.ejecutar-recordatorios.outputs.errores || '0' }}"
        echo ""
        echo "â° PrÃ³xima ejecuciÃ³n: $(date -d '+5 minutes' '+%H:%M:%S')"
        echo "=========================================="
        
        # Crear archivo de log
        echo "# Reporte de Recordatorios" > reporte.log
        echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S')" >> reporte.log
        echo "Citas: ${{ steps.ejecutar-recordatorios.outputs.total_citas || '0' }}" >> reporte.log
        echo "Enviados: ${{ steps.ejecutar-recordatorios.outputs.enviados || '0' }}" >> reporte.log
        echo "Errores: ${{ steps.ejecutar-recordatorios.outputs.errores || '0' }}" >> reporte.log
    
    - name: ðŸš¨ Notificar error
      if: failure()
      run: |
        echo "ðŸš¨ ERROR EN EL PROCESO DE RECORDATORIOS"
        echo "Hora: $(date '+%H:%M:%S')"
        echo "Status: ${{ steps.ejecutar-recordatorios.outputs.http_code }}"
        echo ""
        echo "ðŸ”§ Pasos para solucionar:"
        echo "1. Verificar que la funciÃ³n estÃ© desplegada en Supabase"
        echo "2. Revisar logs de la Edge Function"
        echo "3. Comprobar las credenciales de EmailJS"
        echo "4. Verificar que hay citas para hoy"