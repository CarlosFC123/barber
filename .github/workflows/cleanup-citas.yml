name: Limpieza AutomÃ¡tica de Citas

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ejecutar limpieza
      env:
        SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
        SUPABASE_SERVICE_KEY: '${{ secrets.SUPABASE_SERVICE_KEY }}'
      run: |
        echo "ğŸ”— Ejecutando limpieza de citas..."
        echo "ğŸ• Hora UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ• Hora MÃ©xico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "$SUPABASE_URL/functions/v1/cleanup-expired-appointments" \
          -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')
        
        echo "ğŸ“Š CÃ³digo: $http_code"
        echo "ğŸ“¦ Resultado: $body"