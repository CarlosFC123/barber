name: Limpieza Autom√°tica de Citas

on:
  schedule:
    - cron: '*/5 * * * *' # Ejecuta cada 5 minutos
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
    - name: Limpiar citas expiradas via REST API
      env:
        SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
        SUPABASE_KEY: '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}'  # ¬°NOMBRE CORREGIDO!
      run: |
        echo "üîó Conectando a Supabase..."
        echo "üïê Hora UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "üïê Hora M√©xico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"
        
        # PRIMERO: Verificar que la clave no est√© vac√≠a
        if [ -z "$SUPABASE_KEY" ]; then
          echo "‚ùå ERROR: La clave SUPABASE_KEY est√° VAC√çA"
          echo "Verifica que el secreto 'SUPABASE_SERVICE_ROLE_KEY' existe en GitHub Secrets"
          exit 1
        fi
        
        echo "‚úÖ Longitud de la clave: ${#SUPABASE_KEY} caracteres"
        echo "üîë Prefijo de la clave: ${SUPABASE_KEY:0:20}..."
        
        # Realizar DELETE
        response=$(curl -s -w "\n%{http_code}" -X DELETE \
          "$SUPABASE_URL/rest/v1/citas?estado=in.(cancelada,completada)&expira_en=lt.now()" \
          -H "apikey: $SUPABASE_KEY" \
          -H "Authorization: Bearer $SUPABASE_KEY" \
          -H "Content-Type: application/json" \
          -H "Prefer: return=minimal")

        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')

        echo "üìä C√≥digo de respuesta HTTP: $http_code"
        
        if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 204 ]; then
            echo "‚úÖ Limpieza ejecutada exitosamente"
        else
            echo "‚ùå Error en la solicitud. Detalles: $body"
            
            # DEBUG: Mostrar comando exacto
            echo ""
            echo "üîß Para depurar manualmente, ejecuta:"
            echo "curl -X GET '$SUPABASE_URL/rest/v1/citas?limit=1' \\"
            echo "  -H 'apikey: TU_CLAVE_AQUI' \\"
            echo "  -H 'Authorization: Bearer TU_CLAVE_AQUI'"
            
            exit 1
        fi