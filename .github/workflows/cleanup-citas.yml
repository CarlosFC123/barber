- name: Eliminar citas expiradas
  env:
    SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
    SUPABASE_SERVICE_KEY: 'tu_service_role_key'  # Â¡REEMPLAZA CON TU SERVICE KEY REAL!
  run: |
    echo "ğŸ—‘ï¸ Eliminando citas expiradas..."
    echo "ğŸ• Hora actual del servidor: $(date)"
    
    # Primero, probar que la conexiÃ³n funciona
    echo "ğŸ”— Probando conexiÃ³n con Supabase..."
    test_response=$(curl -s -w "\n%{http_code}" -X GET \
      "$SUPABASE_URL/rest/v1/citas?select=count&estado=eq.completada" \
      -H "apikey: $SUPABASE_SERVICE_KEY" \
      -H "Authorization: Bearer $SUPABASE_SERVICE_KEY")
    
    test_http_code=$(echo "$test_response" | tail -n1)
    test_body=$(echo "$test_response" | sed '$d')
    echo "ğŸ“Š Test conexiÃ³n - CÃ³digo HTTP: $test_http_code"
    echo "ğŸ“Š Test conexiÃ³n - Respuesta: $test_body"
    
    # Ahora ejecutar la funciÃ³n
    echo "ğŸ”„ Ejecutando funciÃ³n de limpieza..."
    response=$(curl -s -w "\n%{http_code}" -X POST \
      "$SUPABASE_URL/functions/v1/cleanup-expired-appointments" \
      -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
      -H "Content-Type: application/json" \
      -d '{}')
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | sed '$d')
    
    echo "ğŸ“Š CÃ³digo HTTP: $http_code"
    echo "ğŸ“¦ Resultado: $body"
    
    # Si hay error, mostrar mÃ¡s detalles
    if [ "$http_code" != "200" ]; then
      echo "âŒ ERROR en la ejecuciÃ³n"
      exit 1
    fi