name: Limpieza AutomÃ¡tica de Citas

on:
  schedule:
    - cron: '*/5 * * * *' # Ejecuta cada 5 minutos
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
    - name: Limpiar citas expiradas via REST API
      env:
        SUPABASE_URL: 'https://nllllvztipbrhryzxamm.supabase.co'
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "ğŸ”— Conectando a Supabase..."
        echo "ğŸ• Hora UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ• Hora MÃ©xico: $(TZ='America/Mexico_City' date '+%Y-%m-%d %H:%M:%S')"

        # Realizar DELETE usando el endpoint REST de Supabase
        # La lÃ³gica ahora estÃ¡ en el trigger: elimina citas donde expira_en < NOW()
        response=$(curl -s -w "\n%{http_code}" -X DELETE \
          "$SUPABASE_URL/rest/v1/citas?and=(estado.in.(\"cancelada\",\"completada\"),expira_en.lt.NOW())" \
          -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
          -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
          -H "Content-Type: application/json" \
          -H "Prefer: return=minimal")

        # Separar el cuerpo de la respuesta del cÃ³digo HTTP
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | sed '$d')

        echo "ğŸ“Š CÃ³digo de respuesta HTTP: $http_code"
        
        if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 204 ]; then
            echo "âœ… Limpieza ejecutada. Respuesta: $body"
        else
            echo "âŒ Error en la solicitud. Detalles: $body"
            exit 1
        fi